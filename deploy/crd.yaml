apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nixbuildrequests.nix.io
spec:
  group: nix.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                sessionId:
                  type: string
                  description: "SessionID links this build request to the SSH proxy session"
                resources:
                  type: object
                  description: "Resources defines the pod resource requirements"
                  properties:
                    limits:
                      type: object
                      additionalProperties:
                        anyOf:
                          - type: integer
                          - type: string
                        pattern: "^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$"
                        x-kubernetes-int-or-string: true
                    requests:
                      type: object
                      additionalProperties:
                        anyOf:
                          - type: integer
                          - type: string
                        pattern: "^(\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\\+|-)?(([0-9]+(\\.[0-9]*)?)|(\\.[0-9]+))))?$"
                        x-kubernetes-int-or-string: true
                image:
                  type: string
                  description: "Image specifies the builder container image"
                timeoutSeconds:
                  type: integer
                  format: int64
                  description: "Timeout for the build in seconds"
                nodeSelector:
                  type: object
                  additionalProperties:
                    type: string
                  description: "NodeSelector for pod placement"
              required:
                - sessionId
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum: ["Pending", "Creating", "Running", "Completed", "Failed"]
                  description: "Phase represents the current state of the build request"
                podName:
                  type: string
                  description: "PodName is the name of the created builder pod"
                podIP:
                  type: string
                  description: "PodIP is the IP address of the builder pod for SSH routing"
                startTime:
                  type: string
                  format: date-time
                  description: "StartTime when the build request was created"
                completionTime:
                  type: string
                  format: date-time
                  description: "CompletionTime when the build finished"
                message:
                  type: string
                  description: "Message provides human-readable status information"
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        description: "Type of condition"
                      status:
                        type: string
                        enum: ["True", "False", "Unknown"]
                        description: "Status of the condition"
                      lastTransitionTime:
                        type: string
                        format: date-time
                        description: "LastTransitionTime is the last time the condition transitioned"
                      reason:
                        type: string
                        description: "Reason is a machine-readable reason for the condition"
                      message:
                        type: string
                        description: "Message is a human-readable message for the condition"
                    required:
                      - type
                      - status
                      - lastTransitionTime
                  description: "Conditions represent the latest observations of the build request state"
          required:
            - spec
      additionalPrinterColumns:
        - name: Phase
          type: string
          description: Build phase
          jsonPath: .status.phase
        - name: Pod
          type: string
          description: Builder pod name
          jsonPath: .status.podName
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
  scope: Namespaced
  names:
    plural: nixbuildrequests
    singular: nixbuildrequest
    kind: NixBuildRequest
    shortNames:
      - nbr
